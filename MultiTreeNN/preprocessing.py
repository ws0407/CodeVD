import json

import pandas as pd
import re
import numpy as np
import torch
from tqdm import tqdm
import os


def prepare_folder(input_json, key, out_path):
    """原始数据集作为输入，提取其中的函数，然后保存为单个的cpp文件，一个文件夹对应一个函数"""
    with open(input_json, 'r') as f:
        data = json.load(f)
    for idx, sample in tqdm(enumerate(data)):
        func = sample[key]
        func_name = func[:func.find("(")].split()[-1]
        if not os.path.exists(out_path + f"{idx}-{func_name}"):
            os.makedirs(out_path + f"{idx}-{func_name}")
        with open(out_path + f"{idx}-{func_name}/{idx}-{func_name}.cpp", 'w') as f:
            f.write(func)
        # print(func)
        # print(func_name)
        # break

def gen_PDG(input_json):
    pass


if __name__ == '__main__':
    prepare_folder('/data/data/ws/CodeVD/IVDetect/data/Reveal/vulnerables.json', 'code', '/data/data/ws/CodeVD/IVDetect/data/Reveal/vulnerable/')
    # prepare_folder('/data/data/ws/CodeVD/IVDetect/data/FFMPeg_Qemu/function.json')

    # _code = 'digraph v4l2_free_buffer {  \r\n\"1000100\" [label = \"(METHOD,v4l2_free_buffer)\" ]\r\n\"1000101\" [label = \"(PARAM,void *opaque)\" ]\r\n\"1000102\" [label = \"(PARAM,uint8_t *unused)\" ]\r\n\"1000103\" [label = \"(BLOCK,,)\" ]\r\n\"1000104\" [label = \"(LOCAL,avbuf: V4L2Buffer *)\" ]\r\n\"1000105\" [label = \"(<operator>.assignment,* avbuf = opaque)\" ]\r\n\"1000106\" [label = \"(IDENTIFIER,avbuf,* avbuf = opaque)\" ]\r\n\"1000107\" [label = \"(IDENTIFIER,opaque,* avbuf = opaque)\" ]\r\n\"1000108\" [label = \"(LOCAL,s: V4L2m2mContext *)\" ]\r\n\"1000109\" [label = \"(<operator>.assignment,*s = buf_to_m2mctx(avbuf))\" ]\r\n\"1000110\" [label = \"(IDENTIFIER,s,*s = buf_to_m2mctx(avbuf))\" ]\r\n\"1000111\" [label = \"(buf_to_m2mctx,buf_to_m2mctx(avbuf))\" ]\r\n\"1000112\" [label = \"(IDENTIFIER,avbuf,buf_to_m2mctx(avbuf))\" ]\r\n\"1000113\" [label = \"(CONTROL_STRUCTURE,if (atomic_fetch_sub(&avbuf->context_refcount, 1) == 1),if (atomic_fetch_sub(&avbuf->context_refcount, 1) == 1))\" ]\r\n\"1000114\" [label = \"(<operator>.equals,atomic_fetch_sub(&avbuf->context_refcount, 1) == 1)\" ]\r\n\"1000115\" [label = \"(atomic_fetch_sub,atomic_fetch_sub(&avbuf->context_refcount, 1))\" ]\r\n\"1000116\" [label = \"(<operator>.addressOf,&avbuf->context_refcount)\" ]\r\n\"1000117\" [label = \"(<operator>.indirectFieldAccess,avbuf->context_refcount)\" ]\r\n\"1000118\" [label = \"(IDENTIFIER,avbuf,atomic_fetch_sub(&avbuf->context_refcount, 1))\" ]\r\n\"1000119\" [label = \"(FIELD_IDENTIFIER,context_refcount,context_refcount)\" ]\r\n\"1000120\" [label = \"(LITERAL,1,atomic_fetch_sub(&avbuf->context_refcount, 1))\" ]\r\n\"1000121\" [label = \"(LITERAL,1,atomic_fetch_sub(&avbuf->context_refcount, 1) == 1)\" ]\r\n\"1000122\" [label = \"(BLOCK,,)\" ]\r\n\"1000123\" [label = \"(atomic_fetch_sub_explicit,atomic_fetch_sub_explicit(&s->refcount, 1, memory_order_acq_rel))\" ]\r\n\"1000124\" [label = \"(<operator>.addressOf,&s->refcount)\" ]\r\n\"1000125\" [label = \"(<operator>.indirectFieldAccess,s->refcount)\" ]\r\n\"1000126\" [label = \"(IDENTIFIER,s,atomic_fetch_sub_explicit(&s->refcount, 1, memory_order_acq_rel))\" ]\r\n\"1000127\" [label = \"(FIELD_IDENTIFIER,refcount,refcount)\" ]\r\n\"1000128\" [label = \"(LITERAL,1,atomic_fetch_sub_explicit(&s->refcount, 1, memory_order_acq_rel))\" ]\r\n\"1000129\" [label = \"(IDENTIFIER,memory_order_acq_rel,atomic_fetch_sub_explicit(&s->refcount, 1, memory_order_acq_rel))\" ]\r\n\"1000130\" [label = \"(CONTROL_STRUCTURE,if (s->reinit),if (s->reinit))\" ]\r\n\"1000131\" [label = \"(<operator>.indirectFieldAccess,s->reinit)\" ]\r\n\"1000132\" [label = \"(IDENTIFIER,s,if (s->reinit))\" ]\r\n\"1000133\" [label = \"(FIELD_IDENTIFIER,reinit,reinit)\" ]\r\n\"1000134\" [label = \"(BLOCK,,)\" ]\r\n\"1000135\" [label = \"(CONTROL_STRUCTURE,if (!atomic_load(&s->refcount)),if (!atomic_load(&s->refcount)))\" ]\r\n\"1000136\" [label = \"(<operator>.logicalNot,!atomic_load(&s->refcount))\" ]\r\n\"1000137\" [label = \"(atomic_load,atomic_load(&s->refcount))\" ]\r\n\"1000138\" [label = \"(<operator>.addressOf,&s->refcount)\" ]\r\n\"1000139\" [label = \"(<operator>.indirectFieldAccess,s->refcount)\" ]\r\n\"1000140\" [label = \"(IDENTIFIER,s,atomic_load(&s->refcount))\" ]\r\n\"1000141\" [label = \"(FIELD_IDENTIFIER,refcount,refcount)\" ]\r\n\"1000142\" [label = \"(sem_post,sem_post(&s->refsync))\" ]\r\n\"1000143\" [label = \"(<operator>.addressOf,&s->refsync)\" ]\r\n\"1000144\" [label = \"(<operator>.indirectFieldAccess,s->refsync)\" ]\r\n\"1000145\" [label = \"(IDENTIFIER,s,sem_post(&s->refsync))\" ]\r\n\"1000146\" [label = \"(FIELD_IDENTIFIER,refsync,refsync)\" ]\r\n\"1000147\" [label = \"(CONTROL_STRUCTURE,else,else)\" ]\r\n\"1000148\" [label = \"(CONTROL_STRUCTURE,if (avbuf->context->streamon),if (avbuf->context->streamon))\" ]\r\n\"1000149\" [label = \"(<operator>.indirectFieldAccess,avbuf->context->streamon)\" ]\r\n\"1000150\" [label = \"(<operator>.indirectFieldAccess,avbuf->context)\" ]\r\n\"1000151\" [label = \"(IDENTIFIER,avbuf,if (avbuf->context->streamon))\" ]\r\n\"1000152\" [label = \"(FIELD_IDENTIFIER,context,context)\" ]\r\n\"1000153\" [label = \"(FIELD_IDENTIFIER,streamon,streamon)\" ]\r\n\"1000154\" [label = \"(ff_v4l2_buffer_enqueue,ff_v4l2_buffer_enqueue(avbuf))\" ]\r\n\"1000155\" [label = \"(IDENTIFIER,avbuf,ff_v4l2_buffer_enqueue(avbuf))\" ]\r\n\"1000156\" [label = \"(av_buffer_unref,av_buffer_unref(&avbuf->context_ref))\" ]\r\n\"1000157\" [label = \"(<operator>.addressOf,&avbuf->context_ref)\" ]\r\n\"1000158\" [label = \"(<operator>.indirectFieldAccess,avbuf->context_ref)\" ]\r\n\"1000159\" [label = \"(IDENTIFIER,avbuf,av_buffer_unref(&avbuf->context_ref))\" ]\r\n\"1000160\" [label = \"(FIELD_IDENTIFIER,context_ref,context_ref)\" ]\r\n\"1000161\" [label = \"(METHOD_RETURN,static void)\" ]\r\n  \"1000100\" -> \"1000101\"  [ label = \"AST: \"] \r\n  \"1000100\" -> \"1000102\"  [ label = \"AST: \"] \r\n  \"1000100\" -> \"1000103\"  [ label = \"AST: \"] \r\n  \"1000100\" -> \"1000161\"  [ label = \"AST: \"] \r\n  \"1000103\" -> \"1000104\"  [ label = \"AST: \"] \r\n  \"1000103\" -> \"1000105\"  [ label = \"AST: \"] \r\n  \"1000103\" -> \"1000108\"  [ label = \"AST: \"] \r\n  \"1000103\" -> \"1000109\"  [ label = \"AST: \"] \r\n  \"1000103\" -> \"1000113\"  [ label = \"AST: \"] \r\n  \"1000105\" -> \"1000106\"  [ label = \"AST: \"] \r\n  \"1000105\" -> \"1000107\"  [ label = \"AST: \"] \r\n  \"1000109\" -> \"1000110\"  [ label = \"AST: \"] \r\n  \"1000109\" -> \"1000111\"  [ label = \"AST: \"] \r\n  \"1000111\" -> \"1000112\"  [ label = \"AST: \"] \r\n  \"1000113\" -> \"1000114\"  [ label = \"AST: \"] \r\n  \"1000113\" -> \"1000122\"  [ label = \"AST: \"] \r\n  \"1000114\" -> \"1000115\"  [ label = \"AST: \"] \r\n  \"1000114\" -> \"1000121\"  [ label = \"AST: \"] \r\n  \"1000115\" -> \"1000116\"  [ label = \"AST: \"] \r\n  \"1000115\" -> \"1000120\"  [ label = \"AST: \"] \r\n  \"1000116\" -> \"1000117\"  [ label = \"AST: \"] \r\n  \"1000117\" -> \"1000118\"  [ label = \"AST: \"] \r\n  \"1000117\" -> \"1000119\"  [ label = \"AST: \"] \r\n  \"1000122\" -> \"1000123\"  [ label = \"AST: \"] \r\n  \"1000122\" -> \"1000130\"  [ label = \"AST: \"] \r\n  \"1000122\" -> \"1000156\"  [ label = \"AST: \"] \r\n  \"1000123\" -> \"1000124\"  [ label = \"AST: \"] \r\n  \"1000123\" -> \"1000128\"  [ label = \"AST: \"] \r\n  \"1000123\" -> \"1000129\"  [ label = \"AST: \"] \r\n  \"1000124\" -> \"1000125\"  [ label = \"AST: \"] \r\n  \"1000125\" -> \"1000126\"  [ label = \"AST: \"] \r\n  \"1000125\" -> \"1000127\"  [ label = \"AST: \"] \r\n  \"1000130\" -> \"1000131\"  [ label = \"AST: \"] \r\n  \"1000130\" -> \"1000134\"  [ label = \"AST: \"] \r\n  \"1000130\" -> \"1000147\"  [ label = \"AST: \"] \r\n  \"1000131\" -> \"1000132\"  [ label = \"AST: \"] \r\n  \"1000131\" -> \"1000133\"  [ label = \"AST: \"] \r\n  \"1000134\" -> \"1000135\"  [ label = \"AST: \"] \r\n  \"1000135\" -> \"1000136\"  [ label = \"AST: \"] \r\n  \"1000135\" -> \"1000142\"  [ label = \"AST: \"] \r\n  \"1000136\" -> \"1000137\"  [ label = \"AST: \"] \r\n  \"1000137\" -> \"1000138\"  [ label = \"AST: \"] \r\n  \"1000138\" -> \"1000139\"  [ label = \"AST: \"] \r\n  \"1000139\" -> \"1000140\"  [ label = \"AST: \"] \r\n  \"1000139\" -> \"1000141\"  [ label = \"AST: \"] \r\n  \"1000142\" -> \"1000143\"  [ label = \"AST: \"] \r\n  \"1000143\" -> \"1000144\"  [ label = \"AST: \"] \r\n  \"1000144\" -> \"1000145\"  [ label = \"AST: \"] \r\n  \"1000144\" -> \"1000146\"  [ label = \"AST: \"] \r\n  \"1000147\" -> \"1000148\"  [ label = \"AST: \"] \r\n  \"1000148\" -> \"1000149\"  [ label = \"AST: \"] \r\n  \"1000148\" -> \"1000154\"  [ label = \"AST: \"] \r\n  \"1000149\" -> \"1000150\"  [ label = \"AST: \"] \r\n  \"1000149\" -> \"1000153\"  [ label = \"AST: \"] \r\n  \"1000150\" -> \"1000151\"  [ label = \"AST: \"] \r\n  \"1000150\" -> \"1000152\"  [ label = \"AST: \"] \r\n  \"1000154\" -> \"1000155\"  [ label = \"AST: \"] \r\n  \"1000156\" -> \"1000157\"  [ label = \"AST: \"] \r\n  \"1000157\" -> \"1000158\"  [ label = \"AST: \"] \r\n  \"1000158\" -> \"1000159\"  [ label = \"AST: \"] \r\n  \"1000158\" -> \"1000160\"  [ label = \"AST: \"] \r\n  \"1000105\" -> \"1000111\"  [ label = \"CFG: \"] \r\n  \"1000109\" -> \"1000119\"  [ label = \"CFG: \"] \r\n  \"1000111\" -> \"1000109\"  [ label = \"CFG: \"] \r\n  \"1000114\" -> \"1000161\"  [ label = \"CFG: \"] \r\n  \"1000114\" -> \"1000127\"  [ label = \"CFG: \"] \r\n  \"1000115\" -> \"1000114\"  [ label = \"CFG: \"] \r\n  \"1000116\" -> \"1000115\"  [ label = \"CFG: \"] \r\n  \"1000117\" -> \"1000116\"  [ label = \"CFG: \"] \r\n  \"1000119\" -> \"1000117\"  [ label = \"CFG: \"] \r\n  \"1000123\" -> \"1000133\"  [ label = \"CFG: \"] \r\n  \"1000124\" -> \"1000123\"  [ label = \"CFG: \"] \r\n  \"1000125\" -> \"1000124\"  [ label = \"CFG: \"] \r\n  \"1000127\" -> \"1000125\"  [ label = \"CFG: \"] \r\n  \"1000131\" -> \"1000141\"  [ label = \"CFG: \"] \r\n  \"1000131\" -> \"1000152\"  [ label = \"CFG: \"] \r\n  \"1000133\" -> \"1000131\"  [ label = \"CFG: \"] \r\n  \"1000136\" -> \"1000146\"  [ label = \"CFG: \"] \r\n  \"1000136\" -> \"1000160\"  [ label = \"CFG: \"] \r\n  \"1000137\" -> \"1000136\"  [ label = \"CFG: \"] \r\n  \"1000138\" -> \"1000137\"  [ label = \"CFG: \"] \r\n  \"1000139\" -> \"1000138\"  [ label = \"CFG: \"] \r\n  \"1000141\" -> \"1000139\"  [ label = \"CFG: \"] \r\n  \"1000142\" -> \"1000160\"  [ label = \"CFG: \"] \r\n  \"1000143\" -> \"1000142\"  [ label = \"CFG: \"] \r\n  \"1000144\" -> \"1000143\"  [ label = \"CFG: \"] \r\n  \"1000146\" -> \"1000144\"  [ label = \"CFG: \"] \r\n  \"1000149\" -> \"1000154\"  [ label = \"CFG: \"] \r\n  \"1000149\" -> \"1000160\"  [ label = \"CFG: \"] \r\n  \"1000150\" -> \"1000153\"  [ label = \"CFG: \"] \r\n  \"1000152\" -> \"1000150\"  [ label = \"CFG: \"] \r\n  \"1000153\" -> \"1000149\"  [ label = \"CFG: \"] \r\n  \"1000154\" -> \"1000160\"  [ label = \"CFG: \"] \r\n  \"1000156\" -> \"1000161\"  [ label = \"CFG: \"] \r\n  \"1000157\" -> \"1000156\"  [ label = \"CFG: \"] \r\n  \"1000158\" -> \"1000157\"  [ label = \"CFG: \"] \r\n  \"1000160\" -> \"1000158\"  [ label = \"CFG: \"] \r\n  \"1000100\" -> \"1000105\"  [ label = \"CFG: \"] \r\n  \"1000142\" -> \"1000161\"  [ label = \"DDG: sem_post(&s->refsync)\"] \r\n  \"1000105\" -> \"1000161\"  [ label = \"DDG: opaque\"] \r\n  \"1000156\" -> \"1000161\"  [ label = \"DDG: &avbuf->context_ref\"] \r\n  \"1000114\" -> \"1000161\"  [ label = \"DDG: atomic_fetch_sub(&avbuf->context_refcount, 1) == 1\"] \r\n  \"1000123\" -> \"1000161\"  [ label = \"DDG: atomic_fetch_sub_explicit(&s->refcount, 1, memory_order_acq_rel)\"] \r\n  \"1000114\" -> \"1000161\"  [ label = \"DDG: atomic_fetch_sub(&avbuf->context_refcount, 1)\"] \r\n  \"1000154\" -> \"1000161\"  [ label = \"DDG: ff_v4l2_buffer_enqueue(avbuf)\"] \r\n  \"1000123\" -> \"1000161\"  [ label = \"DDG: &s->refcount\"] \r\n  \"1000123\" -> \"1000161\"  [ label = \"DDG: memory_order_acq_rel\"] \r\n  \"1000154\" -> \"1000161\"  [ label = \"DDG: avbuf\"] \r\n  \"1000102\" -> \"1000161\"  [ label = \"DDG: unused\"] \r\n  \"1000111\" -> \"1000161\"  [ label = \"DDG: avbuf\"] \r\n  \"1000101\" -> \"1000161\"  [ label = \"DDG: opaque\"] \r\n  \"1000109\" -> \"1000161\"  [ label = \"DDG: s\"] \r\n  \"1000142\" -> \"1000161\"  [ label = \"DDG: &s->refsync\"] \r\n  \"1000136\" -> \"1000161\"  [ label = \"DDG: !atomic_load(&s->refcount)\"] \r\n  \"1000156\" -> \"1000161\"  [ label = \"DDG: av_buffer_unref(&avbuf->context_ref)\"] \r\n  \"1000137\" -> \"1000161\"  [ label = \"DDG: &s->refcount\"] \r\n  \"1000109\" -> \"1000161\"  [ label = \"DDG: buf_to_m2mctx(avbuf)\"] \r\n  \"1000115\" -> \"1000161\"  [ label = \"DDG: &avbuf->context_refcount\"] \r\n  \"1000136\" -> \"1000161\"  [ label = \"DDG: atomic_load(&s->refcount)\"] \r\n  \"1000100\" -> \"1000101\"  [ label = \"DDG: \"] \r\n  \"1000100\" -> \"1000102\"  [ label = \"DDG: \"] \r\n  \"1000101\" -> \"1000105\"  [ label = \"DDG: opaque\"] \r\n  \"1000100\" -> \"1000105\"  [ label = \"DDG: \"] \r\n  \"1000111\" -> \"1000109\"  [ label = \"DDG: avbuf\"] \r\n  \"1000100\" -> \"1000109\"  [ label = \"DDG: \"] \r\n  \"1000105\" -> \"1000111\"  [ label = \"DDG: avbuf\"] \r\n  \"1000100\" -> \"1000111\"  [ label = \"DDG: \"] \r\n  \"1000115\" -> \"1000114\"  [ label = \"DDG: &avbuf->context_refcount\"] \r\n  \"1000115\" -> \"1000114\"  [ label = \"DDG: 1\"] \r\n  \"1000100\" -> \"1000115\"  [ label = \"DDG: \"] \r\n  \"1000100\" -> \"1000114\"  [ label = \"DDG: \"] \r\n  \"1000100\" -> \"1000123\"  [ label = \"DDG: \"] \r\n  \"1000137\" -> \"1000136\"  [ label = \"DDG: &s->refcount\"] \r\n  \"1000123\" -> \"1000137\"  [ label = \"DDG: &s->refcount\"] \r\n  \"1000111\" -> \"1000154\"  [ label = \"DDG: avbuf\"] \r\n  \"1000100\" -> \"1000154\"  [ label = \"DDG: \"] \r\n  \"1000114\" -> \"1000125\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000131\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000127\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000158\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000156\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000123\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000124\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000160\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000133\"  [ label = \"CDG: \"] \r\n  \"1000114\" -> \"1000157\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000153\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000137\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000141\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000152\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000150\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000139\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000136\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000149\"  [ label = \"CDG: \"] \r\n  \"1000131\" -> \"1000138\"  [ label = \"CDG: \"] \r\n  \"1000136\" -> \"1000143\"  [ label = \"CDG: \"] \r\n  \"1000136\" -> \"1000142\"  [ label = \"CDG: \"] \r\n  \"1000136\" -> \"1000146\"  [ label = \"CDG: \"] \r\n  \"1000136\" -> \"1000144\"  [ label = \"CDG: \"] \r\n  \"1000149\" -> \"1000154\"  [ label = \"CDG: \"] \r\n}\r\n'
    #
    # print(_code)
